<html>

  <head>

    <title>Dharmasearch</title>

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/bootstrap-responsive.min.css">
  <link rel="stylesheet" href="css/style.css">
  <link rel="stylesheet" href="css/not.the.skin.css">
  <link rel="stylesheet" href="circle.skin/circle.player.css">

  <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <script type="text/javascript" src="js/jquery.transform.js"></script>
  <script type="text/javascript" src="js/jquery.grab.js"></script>
  <script type="text/javascript" src="js/jquery.jplayer.js"></script>
  <script type="text/javascript" src="js/mod.csstransforms.min.js"></script>
  <script type="text/javascript" src="js/circle.player.js"></script>

  
  <script type="text/javascript">

    /**
    * Initialises the jPlayer audio players on the page
    */
    function init_audios() {
      $.each($(".cp-jplayer"), function(index, value) {
        var el = $(value);
        var myCirclePlayer = new CirclePlayer('#' + el.attr('id'),
        {
          m4a: el.attr("rel")
        }, {
          cssSelectorAncestor: '#' + el.next('.cp-container').attr('id'),
        });
      });
    }

  </script>

  </head>

  <body>

    <div class="container">

      <header>
        <h1 class="brand">Dharmasearch</h1>
      </header>

      <form class="form-search">
        <input class="input-medium search-query input-search", placeholder="Type something" type="text" />
        <button class="btn-large btn-success btn-talks">Search</button>   
      </form>

      <div class="metta"></div>

      <div id="results"></div>

      <script type="text/javascript">

        var talk = {
            name: '',
            option: 'talks',
            list: []    
        };
        $(document).ready(function() {
          $('.form-search').submit(function(e) {
            e.preventDefault();
            talk.name = $('.input-search').val();
            $('.input-search').val(null);
            $.getJSON('http://dharma-api.com/talks?api_key=c5257b4edb77e1d35a797d5ffc9b4691&rpp=10&search=' + talk.name + '&callback=?',
              function(response) {
                // Cache the results
                talk.list = response.results;
                talk.metta = response.metta;
                if(!!talk.metta) {
                  $('#metta').html(null);
                  var metta =   '<ul>'
                      metta +=    '<li>Total metta: <span>' + talk.metta.total + '</span></li>'
                      metta +=    '<li>Ordered by: <span>' + talk.metta.ordered_by + '</span></li>'
                      metta +=    '<li>Loving Kindness: <span>' + talk.metta.loving_kidness + '</span></li>'
                      metta +=  '</ul>'
                      $(metta).appendTo('.metta');  
                }
                if(!!talk.list) {
                  $('#results').html(null);
                  $(talk.list).each(function(i, item) {
                    var picture;
                    if(typeof item.speaker.picture == 'undefined') {
                      picture = 'img/nopic.jpg';
                    } else {
                      picture = item.speaker.picture;
                    }
                    var description;
                    if(typeof item.description == 'undefined') {
                      description = 'A lovely talk.';
                    } else {
                      description = item.description;
                    }

                    var results =   '<div class="row_item row-fluid">';
                        results +=    '<div class="span2">';
                        results +=      '<div class="img_div">';
                        results +=        '<img src="' + picture + '" ' + 'class="speakers_img">';
                        results +=      '</div>';
                        results +=    '</div>';
                        results +=    '<div class="span7">';
                        results +=      '<ul class="talk_details">';
                        results +=        '<li><h1 class="title">' + item.title + '</h1></li>';
                        results +=        '<li>Description: <span>' + description + '</span></li>';
                        results +=        '<li>Speaker: <span>' + item.speaker.name + '</span></li>';
                        results +=        '<li>Date: ' + item.date + '</li>';
                        results +=        '<li>Duration: ' + item.duration + '</li>';
                        results +=        '<li>Source: <span>' + item.source + '</span></li>';
                        results +=        '<li>Licence: <a href="' + + item.license + '">Creative Commons</a></li>';
                        results +=        '<li><a href="' + item.permalink + '">Download &rarr;</a></li>';
                        results +=      '</ul>';
                        results +=    '</div>';
                        results +=    '<div class="span2">';
                        results +=      '<div id="jquery_jplayer_' + item.id + '" class="cp-jplayer" rel="' + item.permalink + '"></div>';
                        results +=      '<div id="cp_container_' + item.id + '" class="cp-container">';
                        results +=        '<div class="cp-buffer-holder"> <!-- .cp-gt50 only needed when buffer is > than 50% -->';
                        results +=          '<div class="cp-buffer-1"></div>';
                        results +=          '<div class="cp-buffer-2"></div>';
                        results +=        '</div>';
                        results +=        '<div class="cp-progress-holder"> <!-- .cp-gt50 only needed when progress is > than 50% -->';
                        results +=          '<div class="cp-progress-1"></div>';
                        results +=          '<div class="cp-progress-2"></div>';
                        results +=        '</div>';
                        results +=        '<div class="cp-circle-control"></div>';
                        results +=        '<ul class="cp-controls">';
                        results +=          '<li><a href="#" class="cp-play" tabindex="1">play</a></li>';
                        results +=          '<li><a href="#" class="cp-pause" style="display:none;" tabindex="1">pause</a></li> <!-- Needs the inline style here, or jQuery.show()uses display:inline instead of display:block -->';
                        results +=        '</ul>';
                        results +=      '</div>';
                        results +=    '</div>';
                        results +=  '</div>';                       
                        $(results).appendTo('#results');   

                  });
                  init_audios();
                };    
              }
            );
          })
          init_audios();
          $('.input-search').focus();
        });

      </script>

    </div>

  </body>

</html>